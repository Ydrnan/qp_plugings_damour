#+begin_src f90 :comment org :tangle ref_idx.irp.f
program ref_idx

  implicit none

  integer, allocatable :: order1(:), order2(:)
  double precision :: max_val
  integer :: i,j,k,s,idx1,idx2
  logical :: loop

  allocate(order1(N_states),order2(N_states))

  order1 = 0
  order2 = 0

  do s = 1, N_states
    max_val = 0d0
    idx2 = 0
    do i = 1, N_det
      if (dabs(psi_coef(i,s)) > max_val) then
        max_val = dabs(psi_coef(i,s))
        idx1 = i
      endif
    enddo
    do i = 1, N_det
      if (dabs(dabs(psi_coef(i,s)) - max_val) <= 1d-10 .and. i /= idx1) then
        idx2 = i
      endif
    enddo
    order1(s) = idx1
    order2(s) = idx2
  enddo

  do s = 1, N_states
    if (s <= 10) then
      write(*,'(A6,I1,I6,A1)') 'ref1 s',s-1, order1(s), ' '
      if (order2(s) /= 0) then
        write(*,'(A6,I1,I6,A1)') 'ref2 s',s-1, order2(s), ' '
      endif
    else
      write(*,'(A6,I2,I6,A1)') 'ref1 s',s-1, order1(s), ' '
      if (order2(s) /= 0) then
        write(*,'(A6,I2,I6,A1)') 'ref2 s',s-1, order2(s), ' '
      endif
    endif
  enddo

end
#+end_src

#+begin_src f90 :comment org :tangle ref_idx2.irp.f
program ref_idx2

  implicit none

  integer, allocatable :: iorder(:)
  double precision, allocatable :: tmp(:), sgn(:)
  integer :: i,s

  allocate(iorder(N_det),tmp(N_det),sgn(N_det))

  do s = 1, N_states
    do i = 1, N_det
      iorder(i) = i
      tmp(i) = - dabs(psi_coef(i,s))
      sgn(i) = - sign(1d0,psi_coef(i,s))
    enddo
    call dsort(tmp,iorder,N_det)
    write(*,'(A7,I4)') ' State:',s
    write(*,'(10(F8.4))') tmp(1:10) * sgn(1:10)
    write(*,'(10(I8))') iorder(1:10)
  enddo

end
#+end_src
